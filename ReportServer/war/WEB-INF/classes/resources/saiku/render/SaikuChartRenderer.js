var SaikuChartRenderer=function(a,b){if(this.rawdata=a,this.cccOptions={},this.data=null,this.hasProcessed=!1,this.hasRendered=!1,!b&&!b.hasOwnProperty("htmlObject"))throw"You need to supply a html object in the options for the SaikuChartRenderer!";if(this.el=$(b.htmlObject),this.id=_.uniqueId("chart_"),$(this.el).html('<div class="canvas_wrapper" style="display:none;"><div id="canvas_'+this.id+'"></div></div>'),this.zoom=b.zoom,b.zoom){var c=this,d="<span style='float:left;' class='zoombuttons'><a href='#' class='button rerender i18n' title='Re-render chart'></a><a href='#' class='button zoomout i18n' style='display:none;' title='Zoom back out'></a></span>";$(d).prependTo($(this.el).find(".canvas_wrapper")),$(this.el).find(".zoomout").on("click",function(a){a.preventDefault(),c.zoomout()}),$(this.el).find(".zoomin").on("click",function(a){a.preventDefault(),c.zoomin()}),$(this.el).find(".rerender").on("click",function(a){a.preventDefault(),$(c.el).find(".zoomout").hide(),c.switch_chart(c.type)})}b.chartDefinition&&(this.chartDefinition=b.chartDefinition),this.cccOptions.canvas="canvas_"+this.id,this.data=null,this.adjustSizeTo=null,b.adjustSizeTo?this.adjustSizeTo=b.adjustSizeTo:this.adjustSizeTo=b.htmlObject,this.rawdata&&("sunburst"==this.type?this.process_data_tree({data:this.rawdata}):this.process_data_tree({data:this.rawdata},!0,!0)),b.mode?this.switch_chart(b.mode):this.switch_chart("stackedBar"),this.adjust()};SaikuChartRenderer.prototype.adjust=function(){var a=this,b=function(){a.hasRendered&&$(a.el).is(":visible")&&a.switch_chart(a.type)},c=_.debounce(b,300);$(window).resize(function(){$(a.el).find(".canvas_wrapper").fadeOut(150),c()})},SaikuChartRenderer.prototype.zoomin=function(){$(this.el).find(".canvas_wrapper").hide();var a=this.chart.root,b=a.data;b.datums(null,{selected:!1}).each(function(a){a.setVisible(!1)}),b.clearSelected(),a.render(!0,!0,!1),this.render_chart_element()},SaikuChartRenderer.prototype.zoomout=function(){var a=this.chart.root,b=a.data,c=a.keptVisibleDatumSet;if(null===c||0===c.length)$(this.el).find(".zoomout").hide();else if(1==c.length)$(this.el).find(".zoomout").hide(),a.keptVisibleDatumSet=[],pvc.data.Data.setVisible(b.datums(null,{visible:!1}),!0);else if(c.length>1){a.keptVisibleDatumSet.splice(c.length-1,1);var d=b.datums(null,{visible:!1}).array(),e=a.keptVisibleDatumSet[c.length-1];_.intersection(e,d).forEach(function(a){a.setVisible(!0)})}a.render(!0,!0,!1)},SaikuChartRenderer.prototype.render=function(){_.delay(this.render_chart_element,0,this)},SaikuChartRenderer.prototype.switch_chart=function(a,b){null==b&&void 0==b||(null==b.chartDefinition&&void 0==b.chartDefinition||(this.chartDefinition=b.chartDefinition),null==b.workspace&&void 0==b.workspace||(this.workspace=b.workspace));var c={stackedBar:{type:"BarChart",stacked:!0},bar:{type:"BarChart"},multiplebar:{type:"BarChart",multiChartIndexes:[1],dataMeasuresInColumns:!0,orientation:"vertical",smallTitlePosition:"top",multiChartMax:30,multiChartColumnsMax:Math.floor(this.cccOptions.width/200),smallWidth:200,smallHeight:150},line:{type:"LineChart"},pie:{type:"PieChart",multiChartIndexes:[0]},heatgrid:{type:"HeatGridChart"},stackedBar100:{type:"NormalizedBarChart"},area:{type:"StackedAreaChart"},dot:{type:"DotChart"},waterfall:{type:"WaterfallChart"},treemap:{type:"TreemapChart"},sunburst:{type:"SunburstChart"},multiplesunburst:{type:"SunburstChart",multiChartIndexes:[1],dataMeasuresInColumns:!0,orientation:"vertical",smallTitlePosition:"top",multiChartMax:30,multiChartColumnsMax:Math.floor(this.cccOptions.width/200),smallWidth:200,smallHeight:150,seriesInRows:!1}};if(null===a||""===a);else if("sunburst"==a){$(this.el).find(".zoombuttons a").hide(),this.type=a;var d=c[a];this.sunburst(d),this.hasProcessed&&this.render()}else if(c.hasOwnProperty(a)){$(this.el).find(".zoombuttons a").hide(),this.type=a;var d=c[a];this.cccOptions=this.getQuickOptions(d),this.define_chart(),this.hasProcessed&&this.render()}else alert("Do not support chart type: '"+a+"'")},SaikuChartRenderer.prototype.sunburst=function(a){this.type="sunburst";var b=this.process_data_tree({data:this.rawdata}),c=this.getQuickOptions(a),f=pv.dom(b).nodes(),g={delayIn:200,delayOut:80,offset:2,html:!0,gravity:"nw",fade:!1,followMouse:!0,corners:!0,arrow:!1,opacity:1},i=(pv.colors(c.colors).by(function(a){return a.parentNode&&a.parentNode.nodeName}),(new pv.Panel).width(c.width).height(c.height).canvas(c.canvas)),j=i.add(pv.Layout.Partition.Fill).nodes(f).size(function(a){return a.nodeValue}).order("descending").orient("radial");j.node.add(pv.Wedge).fillStyle(pv.colors(c.colors).by(function(a){return a.parentNode&&a.parentNode.nodeName})).visible(function(a){return a.depth>0}).strokeStyle("#000").lineWidth(.5).text(function(a){var b="";return"undefined"!=typeof a.nodeValue&&(b=" : "+a.nodeValue),a.nodeName+b}).cursor("pointer").events("all").event("mousemove",pv.Behavior.tipsy(g)),j.label.add(pv.Label).visible(function(a){return a.angle*a.outerRadius>=6}),this.chart=i},SaikuChartRenderer.prototype.cccOptionsDefault={Base:{animate:!1,selectable:!0,valuesVisible:!1,legend:!0,legendPosition:"top",legendAlign:"right",compatVersion:2,legendSizeMax:"30%",axisSizeMax:"40%",plotFrameVisible:!1,orthoAxisMinorTicks:!1,colors:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"]},HeatGridChart:{orientation:"horizontal",useShapes:!0,shape:"circle",nullShape:"cross",colorNormByCategory:!1,sizeRole:"value",legendPosition:"right",legend:!0,hoverable:!0,axisComposite:!0,colors:["red","yellow","lightgreen","darkgreen"],yAxisSize:"20%"},WaterfallChart:{orientation:"horizontal"},PieChart:{multiChartColumnsMax:3,multiChartMax:30,smallTitleFont:"bold 14px sans-serif",valuesVisible:!0,valuesMask:"{category} / {value.percent}",explodedSliceRadius:"10%",extensionPoints:{slice_innerRadiusEx:"40%",slice_offsetRadius:function(a){return a.isSelected()?"10%":0}},clickable:!0},LineChart:{extensionPoints:{area_interpolate:"monotone",line_interpolate:"monotone"}},StackedAreaChart:{extensionPoints:{area_interpolate:"monotone",line_interpolate:"monotone"}},TreemapChart:{legendPosition:"right",multiChartIndexes:0,extensionPoints:{leaf_lineWidth:2},layoutMode:"slice-and-dice",valuesVisible:!0},SunburstChart:{valuesVisible:!1,hoverable:!1,selectable:!0,clickable:!1,multiChartIndexes:[0],multiChartMax:30}},SaikuChartRenderer.prototype.getQuickOptions=function(a){var b=a&&a.type||"BarChart",c=_.extend({type:b,canvas:"canvas_"+this.id},this.cccOptionsDefault.Base,this.cccOptionsDefault[b],a);if(this.adjustSizeTo){var d=$(this.adjustSizeTo);if(d&&d.length>0){var e=d.width()-40,f=d.height()-40;e>0&&(c.width=e),f>0&&(c.height=f)}}return null!==this.data&&this.data.resultset.length>5&&("HeatGridChart"===c.type||"horizontal"!==c.orientation&&(c.extensionPoints=_.extend(Object.create(c.extensionPoints||{}),{xAxisLabel_textAngle:-Math.PI/2,xAxisLabel_textAlign:"right",xAxisLabel_textBaseline:"middle"}))),c.colors=["#AE1717","#AE5B17","#0E6868"],c},SaikuChartRenderer.prototype.define_chart=function(a){this.hasProcessed||this.process_data_tree({data:this.rawdata},!0,!0);var b=this,c=this.adjustSizeTo?$(this.adjustSizeTo):$(this.el),d=null!==this.data&&this.data.height<80&&this.data.width<80,e=null!==this.data&&this.data.height<300&&this.data.width<300,f=!d&&!e,g=!1,h=d,i=c.width()-40,j=c.height()-40,k=_.clone(this.cccOptions);a&&a.width&&(i=a.width),a&&a.height&&(j=a.height),i>0&&(k.width=i),j>0&&(k.height=j),f&&(k.hasOwnProperty("extensionPoints")&&k.extensionPoints.hasOwnProperty("line_interpolate")&&delete k.extensionPoints.line_interpolate,k.hasOwnProperty("extensionPoints")&&k.extensionPoints.hasOwnProperty("area_interpolate")&&delete k.extensionPoints.area_interpolate);var l={legend:{scenes:{item:{execute:function(){var a=this.chart();a.hasOwnProperty("keptVisibleDatumSet")||(a.keptVisibleDatumSet=[]);var b=a.keptVisibleDatumSet.length>0?a.keptVisibleDatumSet[a.keptVisibleDatumSet.length-1]:[],c=b.length>0;c?_.intersection(this.datums().array(),b).forEach(function(a){a.toggleVisible()}):pvc.data.Data.toggleVisible(this.datums()),this.chart().render(!0,!0,!1)}}}},userSelectionAction:function(a){if(0===a.length)return[];var c=b.chart.root,d=c.data,e=this.chart;if(e.hasOwnProperty("keptVisibleDatumSet")||(e.keptVisibleDatumSet=[]),d.datums().count()>1500)pvc.data.Data.setSelected(a,!0);else if(d.datums(null,{visible:!0}).count()==d.datums().count()){$(b.el).find(".zoomout, .rerender").show();var f=d.datums().array();_.each(_.difference(f,a),function(a){a.setVisible(!1)}),e.keptVisibleDatumSet=[],e.keptVisibleDatumSet.push(a)}else{var g=e.keptVisibleDatumSet.length>0?e.keptVisibleDatumSet[e.keptVisibleDatumSet.length-1]:[],h=d.datums(null,{visible:!0}).array(),i=g;h.length<g.length&&(i=h,e.keptVisibleDatumSet.push(h));var j=[];_.each(_.difference(h,a),function(a){a.setVisible(!1)}),_.each(_.intersection(h,a),function(a){j.push(a)}),j.length>0&&e.keptVisibleDatumSet.push(j)}return c.render(!0,!0,!1),[]}};if(k=_.extend(k,{hoverable:h,animate:g},this.chartDefinition),b.zoom){var m=k.legend;k=_.extend(k,l),m===!1&&(k.legend=!1)}"TreemapChart"==k.type&&(k.legend.scenes.item.labelText=function(){var a="",b=this.group;if(b){var c=b.depth;switch(c){case 0:return"";case 1:break;case 2:a=" └ ";break;default:a=new Array(2*(c-2)+1).join(" ")+" └ "}}return a+this.base()}),this.chart=new pvc[k.type](k),this.chart.setData(this.data,{crosstabMode:!0,seriesInRows:!1})},SaikuChartRenderer.prototype.render_chart_element=function(a){var b=a||this,c=null!==b.data&&b.data.height<80&&b.data.width<80,d=null!==b.data&&b.data.height<300&&b.data.width<300,e=!c&&!d,f=!1;if(b.chart.options&&b.chart.options.animate&&(f=!0),!f||$(b.el).find(".canvas_wrapper").is(":visible")){$(b.el).find(".canvas_wrapper");$(b.el).find(".canvas_wrapper").hide()}try{f&&$(b.el).find(".canvas_wrapper").show(),b.chart.render(),b.hasRendered=!0}catch(a){$("#canvas_"+b.id).text("Could not render chart"+a)}return(!b.chart.options||!b.chart.options.animate)&&(isIE||e?$(b.el).find(".canvas_wrapper").show():$(b.el).find(".canvas_wrapper").fadeIn(400),!1)},SaikuChartRenderer.prototype.process_data_tree=function(a,b,c){var d=this,e={};b&&(e.resultset=[],e.metadata=[],e.height=0,e.width=0);var f=e;if("undefined"!=typeof a&&"undefined"!=typeof a.data&&(null===a.data||null===a.data.error)&&!(null===a.data||a.data.cellset&&0===a.data.cellset.length)){var g=a.data.cellset;if(g&&g.length>0){var k,l,m,h=0,i=0,j=!1,n=function(a,b){return a+b};for(k=0,l=g.length;0===i&&k<l;k++)for(var o=0,p=g[k].length;o<p;o++){if(!j)for(;"COLUMN_HEADER"==g[k][o].type&&"null"==g[k][o].value;)k++;if(j=!0,"ROW_HEADER_HEADER"==g[k][o].type){for(;"ROW_HEADER_HEADER"==g[k][o].type;)b&&e.metadata.push({colIndex:o,colType:"String",colName:g[k][o].value}),o++;h=o-1}if("COLUMN_HEADER"==g[k][o].type){for(var q=0,r=[];q<=k;)"null"!==g[q][o].value&&r.push(g[q][o].value),q++;b&&e.metadata.push({colIndex:o,colType:"Numeric",colName:r.join(" ~ ")}),i=k+1}}var t=[];for(m=0;m<=h;m++)t.push(null);for(k=i,l=g.length;k<l;k++)if(""!==g[k][0].value){var u=[],v=[],w=null,x=null;for(m=0;m<=h;m++){if(g[k]&&"null"===g[k][m].value){f=e;for(var y=0;y<h&&"null"===g[k][y].value;y++)f=f[t[y]];y>m&&(m=y)}if(g[k]&&"null"!==g[k][m].value){if(0===m)for(var z=0;z<=h;z++)t[z]=null;"number"==typeof f&&(w[x]={},f=w[x]),x=g[k][m].value,t[m]=x,f.hasOwnProperty(x)||(f[x]={}),w=f,f=f[x]}}v=_.clone(t);for(var A=h+1,B=g[k].length;A<B;A++){var C=g[k][A],D=C.value||0,E=0!==D,F=C.properties.raw;F&&"null"!==F?D=parseFloat(F):"number"!=typeof C.value&&parseFloat(C.value.replace(/[^a-zA-Z 0-9.]+/g,""))&&(D=parseFloat(C.value.replace(/[^a-zA-Z 0-9.]+/g,"")),E=!1),D>0&&E&&(D=C.value&&C.value.indexOf("%")>=0?100*D:D),u.push(D),v.push({f:C.value,v:D})}b&&e.resultset.push(v);var G=_.reduce(u,n,0);x=null===x?"null":x,w[x]=G,f=e}return c&&(d.rawdata=a.data,d.data=e,d.hasProcessed=!0,d.data.height=d.data.resultset.length),e}$(d.el).find(".canvas_wrapper").text("No results").show()}};