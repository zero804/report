/*!
 * Copyright 2002 - 2013 Webdetails, a Pentaho company.  All rights reserved.
 *
 * This software was developed by Webdetails and is provided under the terms
 * of the Mozilla Public License, Version 2.0, or any later version. You may not use
 * this file except in compliance with the license. If you need a copy of the license,
 * please go to  http://mozilla.org/MPL/2.0/. The Initial Developer is Webdetails.
 *
 * Software distributed under the Mozilla Public License is distributed on an "AS IS"
 * basis, WITHOUT WARRANTY OF ANY KIND, either express or  implied. Please refer to
 * the license for the specific language governing your rights and limitations.
 */

!function(){function a(a){return pv.Transform.identity.translate(a.left(),a.top()).times(a.transform())}function b(b){for(var c,d,e,f=b.instance(),g=f.left,h=f.top,i=f.width,j=f.height;e=b.parent;){0>g&&(i+=g,g=0),0>h&&(j+=h,h=0),c=f.right,0>c&&(i+=c),d=f.bottom,0>d&&(j+=d);var k=a(e),l=k.k;g=k.x+l*g,h=k.y+l*h,i=l*i,j=l*j,b=e,f=b.instance()}return{left:g,top:h,width:i,height:j}}var c=0;pv.Behavior.tipsy=function(a){function e(){var a=H.instance(),b=H.properties.tooltip?a.tooltip:"function"==typeof H.tooltip?H.tooltip():a.title||a.text;return"function"==typeof b&&(b=b()),b||""}function f(){var a,c,d,e,f=H.instance();if(H.properties.width){var g=b(H);a=g.left,c=g.top,d=g.width,e=g.height}else{var h,i=H.toScreenTransform();if(H.properties.outerRadius){var j=f.startAngle+f.angle/2;h=f.outerRadius,a=i.x+f.left+h*Math.cos(j),c=i.y+f.top+h*Math.sin(j)}else if(H.properties.shapeRadius){h=Math.max(2,f.shapeRadius);var k=f.left,l=f.top;switch(f.shape){case"diamond":h*=Math.SQRT2;break;case"circle":h/=Math.SQRT2}a=(k-h)*i.k+i.x,c=(l-h)*i.k+i.y,e=d=2*h*i.k}else a=f.left*i.k+i.x,c=f.top*i.k+i.y}var m=Math.ceil(a),n=Math.ceil(c),o=m-a,p=n-c;return d=Math.max(1,Math.floor((d||0)-o)),e=Math.max(1,Math.floor((e||0)-p)),{left:m,top:n,width:d,height:e}}function g(){return A&&(B=A.call(H)||$.fn.tipsy.defaults.gravity),B}function h(a,b){function c(a){var c=b(a);return e(a,c)}function e(a,b){var c=f(b.left,"width"),d=f(b.top,"height"),e=c.fits&&d.fits;return{gravity:a,width:c,height:d,value:c.value+d.value+(2-a.length),isTotal:e,isPartial:!e&&(c.fits||d.fits)}}function f(b,c){var d=j[c],e=a[c],f=b-h[c],g=d-(f+e),i=f>=0&&g>=0,k=(f>=0?f:4*f)+(g>=0?g:4*g);return{fits:i,value:k}}this===C[0]||def.assert();var g=$(window),h={width:g.scrollLeft(),height:g.scrollTop()},j={width:g.width(),height:g.height()},k=B;"c"===k&&(k="w");var l=c(k);if(!l.isTotal){for(var m=P.indexOf(k),n=1,o=P.length;o>n;n++){var p=(m+n)%o;l=i(l,c(P[p]))}d.debug>=21&&k!==l.gravity&&d.log("[TIPSY] #"+z+" Choosing gravity '"+l.gravity+"' over '"+k+"'"),k=l.gravity}return d.debug>=21&&d.log("[TIPSY] #"+z+" Gravity '"+k+"'"),k}function i(a,b){if(a.isTotal){if(!b.isTotal)return a}else if(b.isTotal){if(!a.isTotal)return b}else if(a.isPartial){if(!b.isPartial)return a}else if(b.isPartial&&!a.isPartial)return b;return b.value>a.value?b:a}function j(a){C.css({left:a.left+parseFloat(J.css("padding-left")),top:a.top+parseFloat(J.css("padding-top")),width:a.width,height:a.height})}function k(b){var c=b.root.canvas();J=$(c),c.style.position="relative",J.mouseleave(r),l(),I||(I="tipsyPvBehavior_"+(new Date).getTime());var d=document.getElementById(I);d||(d=document.createElement("div"),d.id=I,c.appendChild(d));var e=d.style;e.padding="0px",e.margin="0px",e.position="absolute",e.pointerEvents="none",e.display="block",e.zIndex=-10,C=$(d),m(),C.data("tipsy",null),C.tipsy(a)}function l(){if(K=J.data("tipsy-pv-shared-info")){var a=J[0].$pvCreateId||0;if(K.createId===a)return void K.behaviors.push(s);K.behaviors.forEach(function(a){a()})}K={createId:J[0].$pvCreateId||0,behaviors:[s]},J.data("tipsy-pv-shared-info",K)}function m(){C&&C.css(d.debug>=22?{borderColor:"red",borderWidth:"1px",borderStyle:"solid",zIndex:1e3}:{borderWidth:"0px",zIndex:-10})}function n(a){a||(a=pv.event);var b=5,c=J.offset();return{left:a.pageX-c.left-b,top:a.pageY-c.top-b,width:10+2*b,height:20}}function o(a,b){(!D&&a||D&&D[0]!==a)&&(d.debug>=20&&d.log("[TIPSY] #"+z+" Changing target element."),D&&(D.unbind("mousemove",v),N||D.unbind("mouseleave",r)),D=a?$(a):null,H=a?b:null,E=F=G=null,D&&(D.mousemove(v),N||D.mouseleave(r)))}function p(){return L++}function q(a){return a===L-1}function r(){var a=p();d.debug>=20&&d.log("[TIPSY] #"+z+" Delayed Hide Begin opId="+a),M>0?window.setTimeout(function(){q(a)?(d.debug>=20&&d.log("[TIPSY] #"+z+" Hiding opId="+a+" nextOperationId="+L),t(a)):d.debug>=20&&d.log("[TIPSY] #"+z+" Delayed Hide Cancelled opId="+a)},M):(d.debug>=20&&d.log("[TIPSY] #"+z+" Hiding Immediately opId="+a),t(a))}function s(){var a=p();d.debug>=20&&d.log("[TIPSY] #"+z+" Hiding as Other opId="+a),t(a)}function t(){o(null,null),C&&C.tipsy("leave")}function u(){var a=K&&K.behaviors;a&&a.length>1&&a.forEach(function(a){a!==s&&a()})}function v(b){if(C&&!(null!=E&&Math.abs(b.clientX-E)<3&&Math.abs(b.clientY-F)<3)){var c,h=this.$scene;if(h&&(c=h.scenes)&&c.mark&&c.mark===H){var i=H.renderId(),k=i!==G,l=a.followMouse;if(l||k){var m=p();d.debug>=20&&d.log("[TIPSY] #"+z+" Updating opId="+m),E=b.clientX,F=b.clientY;var o;l&&(o=n(b)),k&&(G=i,H.context(c,h.index,function(){l||(o=f());var a=e();d.debug>=20&&d.log("[TIPSY] #"+z+" Update text. Was hidden. Text: "+a),C.tipsy("setTitle",a),g()})),j(o),u(),C.tipsy("update")}}}}function w(a){d.debug>=20&&d.log("[TIPSY] #"+z+" Creating"),k(a),N&&a.event("unpoint",r)}function x(b){var c=p();d.debug>=20&&d.log("[TIPSY] #"+z+" Show IN opId="+c),J||w(b);var h=!D;o(pv.event.target,b);var i=e();d.debug>=20&&d.log("[TIPSY] #"+z+" Text: "+i),C.tipsy("setTitle",i),j(a.followMouse?n():f()),g(),u(),C.tipsy(h?"enter":"update"),d.debug>=20&&d.log("[TIPSY] #"+z+" Show OUT")}function y(){var a=this;(!O||O(y,a))&&x(a)}var z=c++;a=a?Object.create(a):{},a.trigger="manual";var A,B=a.gravity||$.fn.tipsy.defaults.gravity;"function"==typeof B&&(A=B,B=null),a.gravity=h;var C,D,E,F,G,H,I,J,K,L=0,M=a.delayOut,N=a.usesPoint,O=a.isEnabled;a.delayOut=0;var P=["nw","n","ne","e","se","s","sw","w"];return y};var d=pv.Behavior.tipsy;d.debug=0,d.setDebug=function(a){d.debug=a},d.log=function(a){"undefined"!=typeof console&&console.log(""+a)}}();